generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  emailVerified DateTime?
  image         String?
  password      String?
  accounts      Account[]
  bookings      Booking[]
  sessions      Session[]
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model Barbershop {
  id             String          @id @default(uuid())
  name           String
  address        String
  phones         String[]
  description    String
  imageUrl       String
  businessNumber String? // CNPJ ou número da empresa
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  businessHours  BusinessHours[]
}

model BusinessHours {
  id           String     @id @default(uuid())
  barbershopId String
  dayOfWeek    Int // 0 = Domingo, 1 = Segunda, etc.
  startTime    String // Formato "HH:mm"
  endTime      String // Formato "HH:mm"
  isAvailable  Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  barbershop   Barbershop @relation(fields: [barbershopId], references: [id], onDelete: Cascade)

  @@unique([barbershopId, dayOfWeek])
}

model BarbershopService {
  id                     String                @id @default(uuid())
  name                   String
  description            String
  imageUrl               String
  price                  Decimal               @db.Decimal(10, 2)
  createdAt              DateTime              @default(now())
  duration               Int                   @default(30)
  updatedAt              DateTime              @default(now()) @updatedAt
  isSubscription         Boolean               @default(false)
  subscriptionInterval   String?
  isActive               Boolean               @default(true)
  cancellationTimeMinutes Int?                  @default(1440)
  maxReschedules         Int?                   @default(1)
  bookings               Booking[]
  professionals          ProfessionalService[]
  subscriptions          Subscription[]
}

model Professional {
  id             String                @id @default(uuid())
  name           String
  profession     String
  imageUrl       String
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  blockedDates   BlockedDate[]
  bookings       Booking[]
  services       ProfessionalService[]
  ratings        Rating[]
  weeklySchedule WeeklySchedule[]
}

model ProfessionalService {
  id             String            @id @default(uuid())
  professionalId String
  serviceId      String
  professional   Professional      @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  service        BarbershopService @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([professionalId, serviceId])
}

model WeeklySchedule {
  id             String       @id @default(uuid())
  professionalId String
  dayOfWeek      Int
  startTime      String
  endTime        String
  isAvailable    Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  professional   Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@unique([professionalId, dayOfWeek])
}

model BlockedDate {
  id             String       @id @default(uuid())
  professionalId String
  date           DateTime
  reason         String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  professional   Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@unique([professionalId, date])
}

model Client {
  id            String         @id @default(uuid())
  name          String
  email         String
  phone         String?
  stripeId      String?        @unique
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  bookings      Booking[]
  subscriptions Subscription[]
}

model Payment {
  id           String        @id @default(uuid())
  stripeId     String        @unique
  amount       Decimal       @db.Decimal(10, 2)
  status       String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  type         String        @default("one_time")
  booking      Booking?
  subscription Subscription?
}

model Subscription {
  id                   String            @id @default(uuid())
  clientId             String
  serviceId            String
  stripeSubscriptionId String            @unique
  status               String
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean           @default(false)
  paymentId            String?           @unique
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  client               Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  payment              Payment?          @relation(fields: [paymentId], references: [id])
  service              BarbershopService @relation(fields: [serviceId], references: [id])
}

model Booking {
  id                String            @id @default(uuid())
  userId            String?
  serviceId         String
  date              DateTime
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  clientId          String?
  paymentId         String?           @unique
  professionalId    String
  ratingId          String?          @unique
  status            String            @default("pending")
  walletPassUrl     String?
  originalBookingId String?
  originalBooking   Booking?          @relation("OriginalBooking", fields: [originalBookingId], references: [id])
  rescheduledBookings Booking[]       @relation("OriginalBooking")
  isRefunded        Boolean           @default(false)
  rescheduleCount   Int               @default(0)
  client            Client?           @relation(fields: [clientId], references: [id])
  payment           Payment?          @relation(fields: [paymentId], references: [id])
  professional      Professional      @relation(fields: [professionalId], references: [id])
  service           BarbershopService @relation(fields: [serviceId], references: [id])
  user              User?             @relation(fields: [userId], references: [id])
  rating            Rating?
}

model Rating {
  id             String       @id @default(uuid())
  bookingId      String       @unique
  professionalId String
  score          Int
  comment        String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  booking        Booking      @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  professional   Professional @relation(fields: [professionalId], references: [id])
}

// Apple Wallet PassKit Web Service
model Device {
  id                      String             @id @default(uuid())
  deviceLibraryIdentifier String             @unique
  pushToken               String?
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  registrations           PassRegistration[]
}

model PassRegistration {
  id                 String   @id @default(uuid())
  deviceId           String
  passTypeIdentifier String // pass.teste.popupsystem.com.br
  serialNumber       String // ID único do passe (geralmente o bookingId)
  pushToken          String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  device             Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@unique([passTypeIdentifier, serialNumber, deviceId])
  @@index([passTypeIdentifier, serialNumber])
}
